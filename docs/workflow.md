# ワークフロー設計書

## 1. 基本的な利用フロー

ユーザーが初めてアプリを使い、基本的な設定を行い、シミュレーション結果を確認するまでの一連の流れ。

1.  **初回アクセス**: ユーザーはアプリにアクセスする。ダッシュボード(F001)が表示され、サンプルデータに基づいたグラフが表示される。
2.  **プラン設定へ**: ユーザーは「プラン変更」ボタンをタップし、収支項目管理モーダル(F003)を開く。
3.  **収入項目の設定**: 
    - `収入`カテゴリの「給与」の「設定」ボタンをタップし、金額設定モーダル(F004)を開く。
    - 自身の給与に合わせて、開始年度、金額、頻度（月額）、昇給率（年率増減）を入力し「保存」する。
4.  **支出項目の設定**: 
    - 同様に`支出`カテゴリの「住宅ローン」や「生活費」などを設定する。
    - 「住宅ローン」では終了年度も設定する。
5.  **資産・負債の設定**:
    - `資産`カテゴリの「預金」の「設定」ボタンをタップし、金額設定モーダル(F004)を開く。
    - 基準年度と現在の預金額（基準額）を入力し「保存」する。
    - `負債`カテゴリの「住宅ローン残債」も同様に設定する。
6.  **モーダルを閉じる**: ユーザーは「保存」ボタンをタップして収支項目管理モーダルを閉じる。
7.  **結果確認**: ダッシュボード(F001)に戻ると、入力された内容に基づいてシミュレーションが再計算され、グラフが更新されている。
8.  **詳細分析**: ユーザーは下部ナビゲーションで「推移」をタップし、推移分析画面(F002)に切り替える。年ごとの詳細な数値を確認する。

## 2. シナリオ比較フロー（プラン機能の活用）

子供の学費について、「すべて国公立」の場合と「高校から私立」の場合を比較検討するシナリオ。

1.  **比較シナリオの準備**: 
    - ユーザーは収支項目管理モーダル(F003)を開き、`支出`カテゴリの「学費」項目の「プラン」ボタン（クリップボードアイコン）をタップ。プラン管理モーダル(F005)が開く。
    - 「プラン追加」ボタンで「高校私立プラン」という名前のプランを新規作成する。
2.  **新プランの金額設定**: 
    - プラン管理モーダルを閉じ、学費項目の「設定」ボタンをタップ。金額設定モーダル(F004)が開く。
    - **この時、モーダル内で操作対象のプランを「高校私立プラン」に切り替えるUIが必要（※モックアップからの追加要件）**。
    - 高校の3年間（例: 開始2035年, 終了2037年）の学費を高い金額で設定し、保存する。
3.  **プランの切り替え**: 
    - 再び学費項目のプラン管理モーダル(F005)を開く。
    - アクティブなプランを「デフォルトプラン」から「高校私立プラン」に切り替える。
4.  **影響の確認**: 
    - モーダルを閉じると、シミュレーションが「高校私立プラン」で再計算される。
    - ユーザーはダッシュボード(F001)のグラフや、推移分析画面(F002)の数値を見て、教育費の増加が将来の資産に与える影響を確認する。
5.  **元のプランに戻す**: 同様の操作で、アクティブなプランを「デフォルトプラン」に戻し、元のシミュレーション結果と比較する。

## 3. システム内部フロー

### シミュレーション計算プロセス
1.  **トリガー**: ユーザーが金額設定(F004)やプラン選択(F005)を変更し、モーダルを閉じる（または保存する）と計算が開始される。
2.  **データ収集**: `PlanState` (Zustandストア) から、全項目のアクティブなプランの設定値を収集する。
3.  **時系列計算**: 
    - シミュレーション期間（例: 50年）を1年ずつループ処理する。
    - **各年の計算**: 
        a. **フロー計算**: その年に有効な全収入・支出項目を合計する。増減率も考慮に入れる。
        b. **ストック計算**: 前年末の資産・負債残高に対し、年率増減と年額増減を適用して年末残高を計算する。
        c. **純資産の計算**: (フロー純収支) + (ストック増減) を前年末の純資産に加算する。
4.  **結果の保存**: 計算結果（年ごとの各指標）を `SimulationState` ストアに保存する。
5.  **UI更新**: `SimulationState` を購読しているグラフやテーブルコンポーネントが自動的に再レンダリングされる。

### データ永続化プロセス
1.  **トリガー**: `PlanState` ストアの状態が変更されるたびに実行される。
2.  **シリアライズ**: `PlanState` の現在の状態オブジェクトを `JSON.stringify()` で文字列に変換する。
3.  **保存**: `localStorage.setItem('cf-simu-data', ...)` を使ってブラウザに保存する。
4.  **復元**: アプリケーションの初回ロード時に `localStorage.getItem('cf-simu-data')` を試みる。データが存在すれば `JSON.parse()` でオブジェクトに戻し、`PlanState` の初期値として設定する。
